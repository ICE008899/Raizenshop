<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raizenshop | ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</title>
    <link rel="stylesheet" href="index.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <h2>Raizen<span>SHOP</span></h2>
        </div>
        <div class="user-menu">
            <div class="wallet">
                <span id="user-balance">üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: 0.00 ‡∏ø</span>
            </div>
            
            <button id="admin-btn" class="btn-admin" style="display:none;" onclick="window.location.href='/Admin.html'">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</button>

            <button class="btn-inbox" onclick="window.location.href='/Inbox.html'" style="background: #00c6ff; color: #000; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 5px;">üì• ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>

            <button class="btn-history" onclick="window.location.href='/History.html'">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</button>
            <button class="btn-topup" onclick="window.location.href='/Topup.html'">‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="btn-Contact" onclick="window.location.href='/Contact.html'">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</button>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="main-container">
        <h1 class="page-title">RAIZENSHOP CMD</h1>
        
        <div id="product-display" class="product-grid">
            <p style="color: #888; text-align: center; width: 100%;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</p>
        </div>
    </div>

    <script>
        const currentUser = localStorage.getItem('loggedInUser');
        const userEmail = localStorage.getItem('userEmail');
        const userRole = localStorage.getItem('userRole');

        if (currentUser && userEmail) {
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
            fetch(`/api/balance?email=${userEmail}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('user-balance').innerText = 'üí∞ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô: ' + parseFloat(data.balance).toLocaleString('en-US', {minimumFractionDigits: 2}) + ' ‡∏ø';
                })
                .catch(error => console.error('Error:', error));

            if (userRole === 'admin') {
                document.getElementById('admin-btn').style.display = 'inline-block';
            }
            
            loadProducts();

        } else {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö');
            window.location.href = '/Login.html';
        }

        function loadProducts() {
            fetch('/api/products') 
                .then(res => res.json())
                .then(data => {
                    const display = document.getElementById('product-display');
                    if (data.length === 0) {
                        display.innerHTML = '<p style="color: #666; text-align: center; width: 100%;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>';
                        return;
                    }

                    display.innerHTML = data.map(product => `
                        <div class="card">
                            <div class="card-image-wrapper">
                                <img src="${product.image_url || 'img/default.jpg'}" alt="product-image" class="card-image">
                            </div>
                            <div class="card-content">
                                <h3>${product.name}</h3>
                                <p class="price">‡∏ø ${parseFloat(product.price).toFixed(2)}</p>
                                <p style="font-size: 0.8rem; color: ${product.stock > 0 ? '#00ff00' : '#ff4d4d'}; margin-bottom: 10px;">
                                    ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô
                                </p>
                                <div class="card-actions">
                                    <button class="btn-detail" onclick="showDetails('${product.name}', '${product.price}', \`${product.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°'}\`)">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                                    
                                    <button class="btn-buy" 
                                            ${product.stock > 0 ? `onclick="buyProduct(${product.id})"` : 'disabled style="background: #444; opacity: 0.6;"'}>
                                            ${product.stock > 0 ? '‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏¢' : '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('product-display').innerHTML = '<p style="color: red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ</p>';
                });
        }

        // ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Pop-up)
        function showDetails(name, price, description) {
            Swal.fire({
                title: `<span style="color: #ffd700">${name}</span>`, // ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏µ‡∏ó‡∏≠‡∏á
                html: `
                    <div style="text-align: left; color: #e0e0e0;">
                        <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                           ‡∏£‡∏≤‡∏Ñ‡∏≤: <span style="color: #00ff00;">${parseFloat(price).toFixed(2)} ‡∏ø</span>
                        </p>
                        <div style="background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #333;">
                            <p style="white-space: pre-wrap; line-height: 1.6; margin: 0; font-size: 0.95rem;">${description}</p>
                        </div>
                    </div>
                `,
                background: '#121212', // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Pop-up ‡∏™‡∏µ‡∏î‡∏≥
                confirmButtonText: '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á',
                confirmButtonColor: '#00c6ff',
                width: '600px'
            });
        }

        function buyProduct(productId) {
            if (!userEmail) return;

            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                fetch('/api/buy-product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: userEmail,
                        productId: productId 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('üéâ ' + data.message);
                        location.reload(); 
                    } else {
                        alert('‚ùå ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        function logout() {
            if(confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userRole');
                window.location.href = '/Login.html';
            }
        }
    </script>
</body>
</html>
