<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | RaizenSHOP</title>
    <link rel="stylesheet" href="Admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <div class="sidebar">
            <h2>Raizen<span>ADMIN</span></h2>
            <button onclick="showSection('reply-messages')">‚úâÔ∏è ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
            <button onclick="showSection('add-product')">üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
            <button onclick="showSection('add-keys')">üîë ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå</button>
            <button onclick="showSection('manage-products')">üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£/‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button onclick="window.location.href='/index.html'" class="btn-home" style="margin-top: 20px;">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
        </div>

        <div class="main-content">
            <section id="reply-messages" class="admin-section">
                <h3>‚úâÔ∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                <div id="messages-list"><p style="color: #888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>
            </section>

            <section id="add-product" class="admin-section" style="display:none;">
                <h3>üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</h3>
                <form id="productForm">
                    <div class="input-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="p_name" required></div>
                    <div class="input-group"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="p_price" required></div>
                    <div class="input-group"><label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="p_url"></div>
                    <div class="input-group"><label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="p_download"></div>
                    <button type="submit" class="btn-save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏£‡πâ‡∏≤‡∏ô</button>
                </form>
            </section>

            <section id="add-keys" class="admin-section" style="display:none;">
                <h3>üîë ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <form id="keyForm">
                    <div class="input-group"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><select id="k_product_id" required></select></div>
                    <div class="input-group"><label>‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><textarea id="k_list" rows="10" required></textarea></div>
                    <button type="submit" class="btn-save" style="background: #28a745;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                </form>
            </section>

            <section id="manage-products" class="admin-section" style="display:none;">
                <h3>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <div id="manage-list"><p style="color: #888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>
            </section>
        </div>
    </div>

    <script>
        const adminName = localStorage.getItem('loggedInUser');
        const userRole = localStorage.getItem('userRole');

        if (!adminName || userRole !== 'admin') {
            alert('‚ö†Ô∏è ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ!');
            window.location.href = '/index.html';
        }

        function showSection(id) {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'reply-messages') loadMessages();
            if(id === 'add-keys') loadProductList(); 
            if(id === 'manage-products') loadManageProducts();
        }

        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
        function loadMessages() {
            fetch(`/api/admin/messages?admin_user=${adminName}`)
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('messages-list');
                    if(data.length === 0) return list.innerHTML = '<p style="color: #666;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö</p>';
                    list.innerHTML = data.map(msg => `
                        <div class="admin-card">
                            <p><b>‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</b> ${msg.username}</p>
                            <p><b>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</b> ${msg.subject}</p>
                            <p style="background: #111; padding: 10px; border-radius: 5px;">${msg.message}</p>
                            ${msg.status === 'replied' 
                                ? `<p style="color: #00ff00;">‚úÖ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${msg.admin_reply}</p>` 
                                : `<div><textarea id="reply-${msg.id}" rows="2" style="width: 100%; padding: 10px; background: #222; color: white;"></textarea>
                                   <button onclick="replyMessage(${msg.id})" style="background: #00c6ff; padding: 8px 15px; cursor: pointer;">‡∏™‡πà‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</button></div>`
                            }
                        </div>
                    `).join('');
                });
        }

        function replyMessage(msgId) {
            const replyText = document.getElementById(`reply-${msgId}`).value;
            if(!replyText) return;
            fetch('/api/admin/reply-message', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_user: adminName, message_id: msgId, reply_text: replyText })
            }).then(() => loadMessages());
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        function loadProductList() {
            fetch(`/api/admin/products?admin_user=${adminName}`).then(res => res.json()).then(data => {
                document.getElementById('k_product_id').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>' + 
                    data.map(p => `<option value="${p.id}">${p.name} (‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${p.stock})</option>`).join('');
            });
        }

        function loadManageProducts() {
            fetch(`/api/admin/products?admin_user=${adminName}`).then(res => res.json()).then(data => {
                const list = document.getElementById('manage-list');
                if(data.length === 0) return list.innerHTML = '<p style="color: #666;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
                list.innerHTML = data.map(p => `
                    <div class="admin-card" style="display: flex; justify-content: space-between;">
                        <div><h4>${p.name}</h4><p>‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${p.stock}</p></div>
                        <button onclick="deleteProduct(${p.id})" style="background: #dc3545; color: white; padding: 5px 15px;">üóëÔ∏è ‡∏•‡∏ö</button>
                    </div>`).join('');
            });
        }

        function deleteProduct(productId) {
            if(!confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á?')) return;
            fetch('/api/admin/delete-product', {
                method: 'DELETE', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_user: adminName, product_id: productId })
            }).then(() => { loadManageProducts(); loadProductList(); });
        }

        document.getElementById('productForm').onsubmit = function(e) {
            e.preventDefault();
            fetch('/api/admin/add-product', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_user: adminName, name: document.getElementById('p_name').value, price: document.getElementById('p_price').value, image_url: document.getElementById('p_url').value, download_url: document.getElementById('p_download').value })
            }).then(() => { alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); this.reset(); loadManageProducts(); });
        };

        document.getElementById('keyForm').onsubmit = function(e) {
            e.preventDefault();
            const keys = document.getElementById('k_list').value.split('\n').map(k => k.trim()).filter(k => k !== "");
            fetch('/api/admin/add-keys', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_user: adminName, product_id: document.getElementById('k_product_id').value, keys: keys })
            }).then(() => { alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); this.reset(); loadProductList(); });
        };

        loadMessages();
    </script>
</body>
</html>