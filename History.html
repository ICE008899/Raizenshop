<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History | RaizenSHOP</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="History.css">
    
    <style>
        /* ‚ú® ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå Dark Theme ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô */
        body {
            font-family: 'Poppins', 'Kanit', sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 40px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h2 { margin: 0; color: white; letter-spacing: 1px; }
        .logo span { color: #ffd700; font-weight: bold; }

        .history-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .page-title {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #fff;
        }
        
        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
            font-size: 0.9rem;
        }

        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
        .history-item {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
            border-left: 5px solid #00c6ff; /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,198,255,0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .product-name { font-size: 1.2rem; font-weight: bold; color: #ffd700; }
        .price { font-size: 1.1rem; color: #00ff00; font-weight: bold; }

        /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á Key */
        .key-box {
            background: #111;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .key-box label {
            display: block;
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .input-wrapper {
            display: flex;
            gap: 10px;
        }
        .input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00c6ff;
            font-family: monospace;
            font-size: 1rem;
            outline: none;
        }
        .btn-copy {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.8rem;
        }
        .btn-copy:hover {
            background: #00c6ff;
            color: black;
            border-color: #00c6ff;
        }

        .btn-download {
            display: block;
            background: #222;
            color: #ccc;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            text-decoration: none;
            border: 1px dashed #555;
            transition: 0.2s;
            margin-bottom: 10px;
        }
        .btn-download:hover {
            border-color: #00ff00;
            color: #00ff00;
            background: #1a2a1a;
        }

        .date {
            text-align: right;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
        }

        .btn-back {
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 30px auto;
            padding: 12px;
            background: transparent;
            border: 1px solid #00c6ff;
            color: #00c6ff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.3s;
        }
        .btn-back:hover {
            background: #00c6ff;
            color: black;
        }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo"><h2>Raizen<span>SHOP</span></h2></div>
        <div style="color: #aaa; font-size: 0.9rem;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
    </div>

    <div class="history-container">
        <h1 class="page-title">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
        <p class="subtitle">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>

        <div id="history-list">
            <p style="text-align: center; color: #aaa; margin-top: 50px;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <button class="btn-back" onclick="window.location.href='/index.html'">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

    <script>
        // ‚ú® ‡∏î‡∏∂‡∏á Email ‡∏à‡∏≤‡∏Å LocalStorage (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Email ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
        const userEmail = localStorage.getItem('userEmail');
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Email ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
        if (!userEmail) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö');
            window.location.href = '/Login.html';
        }

        // ‚ú® ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å username ‡πÄ‡∏õ‡πá‡∏ô email ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ fetch
        fetch('/api/order-history?email=' + userEmail)
            .then(res => res.json())
            .then(orders => {
                const list = document.getElementById('history-list');
                
                if (orders.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 3rem; margin-bottom: 10px;">üì≠</p>
                            <p>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                            <a href="/index.html" style="color: #00c6ff; text-decoration: none;">‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢!</a>
                        </div>
                    `;
                    return;
                }

                // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                list.innerHTML = orders.map(order => `
                    <div class="history-item">
                        <div class="item-header">
                            <span class="product-name">${order.product_name}</span>
                            <span class="price">‡∏ø ${parseFloat(order.product_price).toFixed(2)}</span>
                        </div>
                        
                        <div class="key-box">
                            <label>üîë ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / Key:</label>
                            <div class="input-wrapper">
                                <input type="text" value="${order.product_key}" id="key-${order.id}" readonly>
                                <button class="btn-copy" onclick="copyKey('key-${order.id}')">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                            </div>
                        </div>

                        ${order.download_url ? `
                            <a href="${order.download_url}" target="_blank" class="btn-download">
                                üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                            </a>
                        ` : ''}

                        <div class="date">üìÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(order.purchase_date).toLocaleString('th-TH')}</div>
                    </div>
                `).join('');
            })
            .catch(err => {
                console.error(err);
                document.getElementById('history-list').innerHTML = '<p style="text-align: center; color: #ff4d4d; margin-top: 20px;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            });

        // ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏Ñ‡∏µ‡∏¢‡πå (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
        function copyKey(elementId) {
            const copyText = document.getElementById(elementId);
            
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            copyText.select();
            copyText.setSelectionRange(0, 99999); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠

            // ‡∏™‡∏±‡πà‡∏á‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ
            try {
                navigator.clipboard.writeText(copyText.value).then(() => {
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "Copied!" ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                    const btn = document.querySelector(`button[onclick="copyKey('${elementId}')"]`);
                    const originalText = btn.innerText;
                    btn.innerText = "‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!";
                    btn.style.background = "#00ff00";
                    btn.style.color = "black";
                    
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.style.background = "#333";
                        btn.style.color = "white";
                    }, 2000);
                });
            } catch (err) {
                alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å: " + copyText.value);
            }
        }
    </script>
</body>
</html>
