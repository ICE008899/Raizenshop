<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History | RaizenSHOP</title>
    <link rel="stylesheet" href="History.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="history-container">
        <div class="logo"><h2>Raizen<span>SHOP</span></h2></div>
        <p class="subtitle">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

        <div id="history-list">
            <p style="color: #aaa;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <button class="btn-back" onclick="window.location.href='/index.html'">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>

    <script>
        const currentUser = localStorage.getItem('loggedInUser');
        if (!currentUser) window.location.href = '/Login.html';

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
        fetch('/api/order-history?username=' + currentUser)
            .then(res => res.json())
            .then(orders => {
                const list = document.getElementById('history-list');
                if (orders.length === 0) {
                    list.innerHTML = '<p style="color: #888; margin: 20px 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
                    return;
                }

                list.innerHTML = orders.map(order => `
                    <div class="history-item">
                        <div class="item-header">
                            <span class="product-name">${order.product_name}</span>
                            <span class="price">${order.product_price} ‡∏ø</span>
                        </div>
                        
                        <div class="key-box">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏Ñ‡∏µ‡∏¢‡πå:</label>
                            <div class="input-wrapper">
                                <input type="text" value="${order.product_key}" id="key-${order.id}" readonly>
                                <button class="btn-copy" onclick="copyKey('key-${order.id}')">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                            </div>
                        </div>

                        ${order.download_url ? `
                            <a href="${order.download_url}" target="_blank" class="btn-download">
                                üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                            </a>
                        ` : ''}

                        <div class="date">${new Date(order.purchase_date).toLocaleString('th-TH')}</div>
                    </div>
                `).join('');
            })
            .catch(err => {
                console.error(err);
                document.getElementById('history-list').innerHTML = '<p style="color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
            });

        // ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏Ñ‡∏µ‡∏¢‡πå
        function copyKey(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            navigator.clipboard.writeText(copyText.value);
            
            alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß: " + copyText.value);
        }
    </script>
</body>
</html>