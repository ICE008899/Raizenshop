<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° | RaizenSHOP</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="Inbox.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <h2>Raizen<span>SHOP</span></h2>
        </div>
        <div class="user-menu">
            <span id="user-display" style="margin-right: 15px; color: #ccc;"></span>
            <button class="btn-history" onclick="window.location.href='/index.html'">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>
    </nav>

    <div class="inbox-wrapper">
        <h1 class="page-title" style="text-align: left; margin-bottom: 30px;">üì• ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
        
        <div id="inbox-container">
            <p style="text-align: center; color: #888;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</p>
        </div>
    </div>

    <script>
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const currentUser = localStorage.getItem('loggedInUser');
        
        if (!currentUser) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏±‡∏ö');
            window.location.href = '/Login.html';
        } else {
            document.getElementById('user-display').innerText = 'üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ' + currentUser;
            loadInboxMessages();
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å Server
        function loadInboxMessages() {
            fetch(`/api/user/messages?username=${currentUser}`)
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('inbox-container');
                    
                    if(data.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 50px; background: #1e1e1e; border-radius: 12px;">
                                <h3 style="color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                                <p style="color: #444; margin-top: 10px;">‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö</p>
                            </div>
                        `;
                        return;
                    }

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    container.innerHTML = data.map(msg => {
                        const isReplied = msg.status === 'replied';
                        
                        return `
                            <div class="inbox-card" style="${isReplied ? 'border-left-color: #00ff00;' : ''}">
                                <div class="inbox-header">
                                    <h3>üè∑Ô∏è ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${msg.subject}</h3>
                                    <span class="status-badge ${isReplied ? 'status-replied' : 'status-pending'}">
                                        ${isReplied ? '‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‚è≥ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö'}
                                    </span>
                                </div>
                                <p class="msg-date">‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(msg.sent_at).toLocaleString('th-TH')}</p>
                                
                                <div class="msg-body">
                                    <p style="color: #bbb; font-size: 0.9rem; margin-bottom: 5px;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</p>
                                    <p style="color: #fff;">${msg.message}</p>
                                </div>
                                
                                ${isReplied ? `
                                <div class="msg-reply">
                                    <h4>üë®‚Äçüíª ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:</h4>
                                    <p style="color: #e0e0e0;">${msg.admin_reply}</p>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                })
                .catch(err => {
                    console.error("Error fetching messages:", err);
                    document.getElementById('inbox-container').innerHTML = '<p style="color: red; text-align: center;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ</p>';
                });
        }
    </script>
</body>
</html>